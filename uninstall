#!/usr/bin/env bash

set -euo pipefail

# CONFIGURATION
readonly SCRIPT_VERSION="1.0.1"
readonly SCRIPT_CODENAME="Purge"
readonly AUTHOR="0xb0rn3"
readonly REPO_URL="https://github.com/0xb0rn3/kygox"

# System Configuration
readonly ORIGINAL_USER="${SUDO_USER:-$(whoami)}"
readonly USER_HOME=$(getent passwd "$ORIGINAL_USER" | cut -d: -f6)
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly LOG_DIR="$USER_HOME/.kygox"
readonly CONFIG_DIR="$USER_HOME/.config/kygox"
readonly BACKUP_DIR="$CONFIG_DIR/backups/uninstall_$(date +%Y%m%d_%H%M%S)"

# Colors and UI
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly PURPLE='\033[0;35m'
readonly CYAN='\033[0;36m'
readonly WHITE='\033[1;37m'
readonly BOLD='\033[1m'
readonly DIM='\033[2m'
readonly RESET='\033[0m'

# Global State
declare -g VERBOSE_MODE=false
declare -g DRY_RUN=false
declare -g FORCE_REMOVE=false
declare -g KEEP_CONFIG=false
declare -g KEEP_REPO=false
declare -g LOADER_PID=""
declare -A REMOVAL_STATS=(
    ["total_available"]=0
    ["total_installed"]=0
    ["removed"]=0
    ["failed"]=0
)

# ============================================================================
# ANIMATED LOADERS (Same as installer)
# ============================================================================

show_purge_loader() {
    local message="$1"
    local duration="${2:-5}"
    local pid="$$"
    
    (
        local frames=(
            "ğŸ—‘ï¸ "
            "ğŸ—‘ï¸."
            "ğŸ—‘ï¸.."
            "ğŸ—‘ï¸..."
            "â™»ï¸..."
            "â™»ï¸.."
            "â™»ï¸."
            "â™»ï¸ "
        )
        
        local start_time=$(date +%s)
        local i=0
        
        tput civis
        
        while kill -0 $pid 2>/dev/null; do
            local current_time=$(date +%s)
            local elapsed=$((current_time - start_time))
            
            if [[ $elapsed -ge $duration ]]; then
                break
            fi
            
            local frame="${frames[$((i % ${#frames[@]}))]}"
            local progress=$((elapsed * 100 / duration))
            
            local bar_width=40
            local filled=$((progress * bar_width / 100))
            local empty=$((bar_width - filled))
            
            printf "\r${RED}${BOLD}$frame ${message}${RESET} "
            printf "${RED}["
            printf "%${filled}s" | tr ' ' 'â–ˆ'
            printf "%${empty}s" | tr ' ' 'â–‘'
            printf "]${RESET} ${YELLOW}${progress}%%${RESET}"
            
            ((i++))
            sleep 0.1
        done
        
        printf "\r${GREEN}${BOLD}âœ“ ${message}${RESET}%*s\n" $(($(tput cols) - ${#message} - 3)) ""
        tput cnorm
    ) &
    
    LOADER_PID=$!
}

show_scan_loader() {
    local message="$1"
    local duration="${2:-5}"
    local pid="$$"
    
    (
        local start_time=$(date +%s)
        local i=0
        
        tput civis
        
        while kill -0 $pid 2>/dev/null; do
            local current_time=$(date +%s)
            local elapsed=$((current_time - start_time))
            
            if [[ $elapsed -ge $duration ]]; then
                break
            fi
            
            local progress=$((elapsed * 100 / duration))
            local bar_width=50
            local pos=$((i % bar_width))
            
            printf "\r${CYAN}${BOLD}ğŸ” ${message}${RESET} ${DIM}["
            for ((j=0; j<bar_width; j++)); do
                if [[ $j -eq $pos ]]; then
                    printf "${GREEN}${BOLD}â—†${RESET}${DIM}"
                else
                    printf "â”€"
                fi
            done
            printf "]${RESET} ${YELLOW}${progress}%%${RESET}"
            
            ((i++))
            sleep 0.05
        done
        
        printf "\r${GREEN}${BOLD}âœ“ ${message}${RESET}%*s\n" $(($(tput cols) - ${#message} - 3)) ""
        tput cnorm
    ) &
    
    LOADER_PID=$!
}

stop_loader() {
    if [[ -n "$LOADER_PID" ]] && kill -0 $LOADER_PID 2>/dev/null; then
        kill $LOADER_PID 2>/dev/null || true
        wait $LOADER_PID 2>/dev/null || true
    fi
    LOADER_PID=""
    tput cnorm
}

# ============================================================================
# CORE FUNCTIONS
# ============================================================================

log_message() {
    local level="$1"
    local message="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    mkdir -p "$LOG_DIR"
    echo "[$timestamp] [$level] $message" >> "$LOG_DIR/kygox_uninstall.log"
    
    if [[ "$VERBOSE_MODE" == "true" ]]; then
        echo "[$level] $message" >&2
    fi
}

error_exit() {
    local message="$1"
    local exit_code="${2:-1}"
    stop_loader
    log_message "ERROR" "$message"
    echo -e "${RED}${BOLD}[ERROR]${RESET} $message" >&2
    exit "$exit_code"
}

print_banner() {
    clear
    cat << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                      â•‘
â•‘        â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—                  â•‘
â•‘        â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•                  â•‘
â•‘        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ•”â•                   â•‘
â•‘        â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—                   â•‘
â•‘        â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—                  â•‘
â•‘        â•šâ•â•  â•šâ•â•   â•šâ•â•    â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•                  â•‘
â•‘                                                                      â•‘
â•‘              ğŸ—‘ï¸  UNINSTALLER v1.0.1 Purge  â™»ï¸                        â•‘
â•‘                By 0xb0rn3 | IG: theehiv3 | X: 0xbv1                 â•‘
â•‘                                                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
    echo
    echo -e "${CYAN}${BOLD}How it works:${RESET}"
    echo -e "  ${WHITE}1.${RESET} Query BlackArch repository for master package list"
    echo -e "  ${WHITE}2.${RESET} Correlate with installed packages on your system"
    echo -e "  ${WHITE}3.${RESET} Remove only packages found in correlation"
    echo -e "  ${WHITE}4.${RESET} Clean repository configuration"
    echo
}

check_root() {
    log_message "INFO" "Checking root privileges..."
    
    if [[ $EUID -ne 0 ]]; then
        echo
        echo -e "${RED}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
        echo -e "${RED}${BOLD}â•‘                  ROOT PRIVILEGES REQUIRED                 â•‘${RESET}"
        echo -e "${RED}${BOLD}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${RESET}"
        echo -e "${RED}${BOLD}â•‘${RESET}  This script must be run with sudo/root privileges      ${RED}${BOLD}â•‘${RESET}"
        echo -e "${RED}${BOLD}â•‘${RESET}                                                         ${RED}${BOLD}â•‘${RESET}"
        echo -e "${RED}${BOLD}â•‘${RESET}  Run with: ${GREEN}sudo ./uninstall${RESET}                          ${RED}${BOLD}â•‘${RESET}"
        echo -e "${RED}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
        echo
        log_message "ERROR" "Script not run with root privileges"
        exit 1
    fi
    
    log_message "INFO" "Running with root privileges"
}

verify_blackarch_repository() {
    echo -e "${CYAN}${BOLD}[*] Verifying BlackArch Repository${RESET}"
    echo
    
    log_message "INFO" "Checking BlackArch repository configuration..."
    
    # Check if BlackArch is in pacman.conf
    if ! grep -q "^\[blackarch\]" /etc/pacman.conf 2>/dev/null; then
        echo -e "${RED}[âœ—] BlackArch repository not found in pacman.conf${RESET}"
        echo -e "${YELLOW}[!] Cannot scan for packages without repository configuration${RESET}"
        echo
        echo -e "${CYAN}${BOLD}Why this is required:${RESET}"
        echo -e "  ${WHITE}â€¢${RESET} The uninstaller needs to query BlackArch repository"
        echo -e "  ${WHITE}â€¢${RESET} It correlates repo packages with installed packages"
        echo -e "  ${WHITE}â€¢${RESET} This ensures we only remove BlackArch tools"
        echo
        echo -e "${GREEN}[i] If you've already removed BlackArch completely, there's nothing to uninstall${RESET}"
        return 1
    fi
    
    echo -e "${GREEN}[âœ“] BlackArch repository found in pacman.conf${RESET}"
    
    # Try to access the repository
    echo -e "${CYAN}[*] Testing repository accessibility...${RESET}"
    
    show_scan_loader "Connecting to BlackArch repository" 2 &
    local loader_pid=$!
    
    if ! pacman -Sl blackarch &>/dev/null; then
        wait $loader_pid 2>/dev/null || true
        echo -e "${RED}[âœ—] Cannot access BlackArch repository${RESET}"
        echo -e "${YELLOW}[!] Repository is configured but not accessible${RESET}"
        echo
        echo -e "${CYAN}Try running: ${WHITE}sudo pacman -Sy${RESET}"
        return 1
    fi
    
    wait $loader_pid 2>/dev/null || true
    
    echo -e "${GREEN}[âœ“] BlackArch repository is accessible${RESET}"
    log_message "INFO" "BlackArch repository verified and accessible"
    echo
    
    return 0
}

create_backup() {
    log_message "INFO" "Creating backup before uninstallation..."
    echo -e "${CYAN}[*] Creating backup...${RESET}"
    
    mkdir -p "$BACKUP_DIR"
    
    # Backup pacman.conf
    if [[ -f /etc/pacman.conf ]]; then
        cp /etc/pacman.conf "$BACKUP_DIR/pacman.conf.backup"
        log_message "INFO" "Backed up pacman.conf"
    fi
    
    # Backup BlackArch mirrorlist
    if [[ -f /etc/pacman.d/blackarch-mirrorlist ]]; then
        cp /etc/pacman.d/blackarch-mirrorlist "$BACKUP_DIR/blackarch-mirrorlist.backup"
        log_message "INFO" "Backed up BlackArch mirrorlist"
    fi
    
    # Save list of installed BlackArch packages
    if command -v pacman &>/dev/null; then
        pacman -Qq 2>/dev/null | while read pkg; do
            if pacman -Qi "$pkg" 2>/dev/null | grep -q "^Repository.*blackarch"; then
                echo "$pkg"
            fi
        done > "$BACKUP_DIR/blackarch_packages.txt"
        log_message "INFO" "Saved list of installed packages"
    fi
    
    echo -e "${GREEN}[+] Backup created at: ${DIM}$BACKUP_DIR${RESET}"
    echo
}

scan_blackarch_packages() {
    echo -e "${CYAN}${BOLD}[*] Scanning System - Correlating with BlackArch Repository${RESET}"
    echo
    
    # Step 1: Query ALL packages from BlackArch repository
    echo -e "${CYAN}[*] Step 1/3: Querying BlackArch Repository${RESET}"
    echo -e "${DIM}  â†’ Fetching master list of ALL BlackArch packages${RESET}"
    
    show_scan_loader "Fetching BlackArch package list" 3 &
    local loader_pid=$!
    
    local all_blackarch_packages=()
    
    # Get all packages from blackarch repo
    mapfile -t all_blackarch_packages < <(pacman -Sl blackarch 2>/dev/null | awk '{print $2}' | sort -u)
    
    REMOVAL_STATS["total_available"]=${#all_blackarch_packages[@]}
    
    wait $loader_pid 2>/dev/null || true
    
    if [[ ${#all_blackarch_packages[@]} -eq 0 ]]; then
        echo -e "${RED}[âœ—] No packages found in BlackArch repository${RESET}"
        log_message "ERROR" "BlackArch repository returned no packages"
        return 1
    fi
    
    echo -e "${GREEN}[âœ“] Found ${REMOVAL_STATS[total_available]} packages in BlackArch repository${RESET}"
    log_message "INFO" "Retrieved ${REMOVAL_STATS[total_available]} packages from BlackArch repo"
    echo
    
    # Step 2: Get ALL installed packages (FAST - single command)
    echo -e "${CYAN}[*] Step 2/3: Getting Installed Packages${RESET}"
    echo -e "${DIM}  â†’ Fetching list of all installed packages on system${RESET}"
    
    show_scan_loader "Reading installed packages" 2 &
    loader_pid=$!
    
    local all_installed_packages=()
    
    # Get ALL installed packages in one fast command
    mapfile -t all_installed_packages < <(pacman -Qq 2>/dev/null | sort -u)
    
    wait $loader_pid 2>/dev/null || true
    
    echo -e "${GREEN}[âœ“] Found ${#all_installed_packages[@]} total installed packages${RESET}"
    log_message "INFO" "System has ${#all_installed_packages[@]} installed packages"
    echo
    
    # Step 3: FAST CORRELATION - Find intersection using associative array
    echo -e "${CYAN}[*] Step 3/3: Correlating Packages${RESET}"
    echo -e "${DIM}  â†’ Finding intersection: BlackArch repo âˆ© Installed packages${RESET}"
    
    show_scan_loader "Performing correlation analysis" 2 &
    loader_pid=$!
    
    # Create associative array of installed packages for O(1) lookup
    declare -A installed_lookup
    for pkg in "${all_installed_packages[@]}"; do
        installed_lookup["$pkg"]=1
    done
    
    # Find intersection: packages in both BlackArch repo AND installed
    local installed_blackarch_packages=()
    for pkg in "${all_blackarch_packages[@]}"; do
        if [[ "${installed_lookup[$pkg]:-0}" == "1" ]]; then
            installed_blackarch_packages+=("$pkg")
        fi
    done
    
    REMOVAL_STATS["total_installed"]=${#installed_blackarch_packages[@]}
    
    wait $loader_pid 2>/dev/null || true
    
    echo -e "${GREEN}[âœ“] Correlation complete: ${REMOVAL_STATS[total_installed]} matches found${RESET}"
    log_message "INFO" "Correlation found ${REMOVAL_STATS[total_installed]} installed BlackArch packages"
    echo
    
    # Display correlation results
    echo -e "${GREEN}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
    echo -e "${GREEN}${BOLD}â•‘               BLACKARCH PACKAGE CORRELATION              â•‘${RESET}"
    echo -e "${GREEN}${BOLD}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${RESET}"
    echo -e "${GREEN}${BOLD}â•‘${RESET}  Total in BlackArch Repo:      ${WHITE}${BOLD}${REMOVAL_STATS[total_available]}${RESET} packages"
    echo -e "${GREEN}${BOLD}â•‘${RESET}  Total Installed on System:    ${WHITE}${#all_installed_packages[@]}${RESET} packages"
    echo -e "${GREEN}${BOLD}â•‘${RESET}  BlackArch Packages Found:     ${RED}${BOLD}${REMOVAL_STATS[total_installed]}${RESET} packages"
    
    if [[ ${REMOVAL_STATS[total_available]} -gt 0 ]]; then
        local correlation_rate=$(( REMOVAL_STATS[total_installed] * 100 / REMOVAL_STATS[total_available] ))
        echo -e "${GREEN}${BOLD}â•‘${RESET}  Correlation Rate:             ${YELLOW}${correlation_rate}%${RESET}"
    fi
    
    echo -e "${GREEN}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo
    
    if [[ ${REMOVAL_STATS[total_installed]} -eq 0 ]]; then
        echo -e "${GREEN}[+] No BlackArch packages found installed${RESET}"
        echo -e "${GREEN}[+] Your system is clean!${RESET}"
        return 1
    fi
    
    # Show sample of packages that will be removed
    echo -e "${YELLOW}${BOLD}Packages found (showing first 30 of ${REMOVAL_STATS[total_installed]}):${RESET}"
    echo
    
    local count=0
    for pkg in "${installed_blackarch_packages[@]}"; do
        if [[ $count -ge 30 ]]; then
            echo -e "  ${DIM}... and $((${#installed_blackarch_packages[@]} - 30)) more packages${RESET}"
            break
        fi
        
        # Show package name (descriptions would require pacman -Qi which is slow)
        echo -e "  ${RED}â€¢${RESET} ${CYAN}$pkg${RESET}"
        ((count++))
    done
    echo
    
    # Return the correlated list for removal
    printf '%s\n' "${installed_blackarch_packages[@]}"
}

remove_package() {
    local package="$1"
    
    if [[ "$DRY_RUN" == "true" ]]; then
        echo -e "${YELLOW}[DRY RUN] Would remove: $package${RESET}"
        ((REMOVAL_STATS["removed"]++))
        return 0
    fi
    
    log_message "INFO" "Removing package: $package"
    
    # Try multiple removal methods
    if pacman -Rns --noconfirm "$package" >> "$LOG_DIR/kygox_uninstall.log" 2>&1; then
        echo -e "${GREEN}[+] Removed: $package${RESET}"
        ((REMOVAL_STATS["removed"]++))
        return 0
    elif pacman -Rn --noconfirm "$package" >> "$LOG_DIR/kygox_uninstall.log" 2>&1; then
        echo -e "${GREEN}[+] Removed (no deps): $package${RESET}"
        ((REMOVAL_STATS["removed"]++))
        return 0
    elif pacman -Rdd --noconfirm "$package" >> "$LOG_DIR/kygox_uninstall.log" 2>&1; then
        echo -e "${YELLOW}[!] Removed (forced): $package${RESET}"
        ((REMOVAL_STATS["removed"]++))
        return 0
    else
        echo -e "${RED}[!] Failed: $package${RESET}"
        log_message "ERROR" "Failed to remove: $package"
        ((REMOVAL_STATS["failed"]++))
        return 1
    fi
}

remove_packages() {
    local packages=("$@")
    
    if [[ ${#packages[@]} -eq 0 ]]; then
        echo -e "${YELLOW}[!] No packages to remove${RESET}"
        return 0
    fi
    
    echo -e "${CYAN}${BOLD}[*] Removing ${#packages[@]} BlackArch Packages${RESET}"
    echo
    
    if [[ "$DRY_RUN" != "true" ]]; then
        show_purge_loader "Preparing removal process" 2 &
        wait $LOADER_PID 2>/dev/null || true
    fi
    
    # Process in batches for better output
    local batch_size=10
    local total_batches=$(( (${#packages[@]} + batch_size - 1) / batch_size ))
    
    for ((i=0; i<${#packages[@]}; i+=batch_size)); do
        local batch=("${packages[@]:i:batch_size}")
        local batch_num=$(( i / batch_size + 1 ))
        
        echo -e "${CYAN}[*] Batch $batch_num/$total_batches${RESET}"
        
        for pkg in "${batch[@]}"; do
            remove_package "$pkg"
        done
        
        local progress=$(( (i + batch_size) * 100 / ${#packages[@]} ))
        if [[ $progress -gt 100 ]]; then
            progress=100
        fi
        echo -e "${GREEN}[+] Progress: ${progress}% (Removed: ${REMOVAL_STATS[removed]}, Failed: ${REMOVAL_STATS[failed]})${RESET}"
        echo
    done
}

remove_blackarch_repository() {
    echo -e "${CYAN}${BOLD}[*] Removing BlackArch Repository Configuration${RESET}"
    echo
    
    if [[ "$DRY_RUN" == "true" ]]; then
        echo -e "${YELLOW}[DRY RUN] Would remove BlackArch repository configuration${RESET}"
        return 0
    fi
    
    show_purge_loader "Cleaning repository configuration" 3 &
    local loader_pid=$!
    
    # Remove BlackArch from pacman.conf
    if [[ -f /etc/pacman.conf ]]; then
        sed -i '/^\[blackarch\]/,/^$/d' /etc/pacman.conf
        log_message "INFO" "Removed BlackArch from pacman.conf"
    fi
    
    # Remove BlackArch mirrorlist
    if [[ -f /etc/pacman.d/blackarch-mirrorlist ]]; then
        rm -f /etc/pacman.d/blackarch-mirrorlist
        log_message "INFO" "Removed BlackArch mirrorlist"
    fi
    
    # Remove BlackArch keyring package
    if pacman -Qi blackarch-keyring &>/dev/null; then
        pacman -Rns --noconfirm blackarch-keyring >> "$LOG_DIR/kygox_uninstall.log" 2>&1 || true
        log_message "INFO" "Removed BlackArch keyring package"
    fi
    
    # Remove BlackArch keys from pacman keyring
    pacman-key --delete 4345771566D76038C7FEB43863EC0ADBEA87E4E3 2>/dev/null || true
    
    wait $loader_pid 2>/dev/null || true
    
    echo -e "${GREEN}[+] BlackArch repository configuration removed${RESET}"
    echo
}

clean_kygox_files() {
    if [[ "$KEEP_CONFIG" == "true" ]]; then
        echo -e "${YELLOW}[!] Keeping kygox configuration files${RESET}"
        return 0
    fi
    
    echo -e "${CYAN}${BOLD}[*] Cleaning kygox Files${RESET}"
    echo
    
    local files_to_remove=(
        "$CONFIG_DIR"
        "$LOG_DIR"
    )
    
    for file in "${files_to_remove[@]}"; do
        # Don't remove backup directory we just created
        if [[ "$file" == *"$BACKUP_DIR"* ]]; then
            continue
        fi
        
        if [[ -n "$file" && -e "$file" ]]; then
            if [[ "$DRY_RUN" == "true" ]]; then
                echo -e "${YELLOW}[DRY RUN] Would remove: $file${RESET}"
            else
                # Keep the backup directory
                if [[ "$file" == "$CONFIG_DIR" ]]; then
                    find "$file" -mindepth 1 -maxdepth 1 ! -path "*/backups" -exec rm -rf {} + 2>/dev/null || true
                else
                    rm -rf "$file" 2>/dev/null || true
                fi
                echo -e "${GREEN}[+] Cleaned: $file${RESET}"
                log_message "INFO" "Removed: $file"
            fi
        fi
    done
    
    echo
}

sync_databases() {
    if [[ "$DRY_RUN" == "true" ]]; then
        echo -e "${YELLOW}[DRY RUN] Would synchronize package databases${RESET}"
        return 0
    fi
    
    echo -e "${CYAN}[*] Synchronizing package databases...${RESET}"
    
    show_scan_loader "Updating package databases" 2 &
    local loader_pid=$!
    
    pacman -Sy --noconfirm >> "$LOG_DIR/kygox_uninstall.log" 2>&1
    
    wait $loader_pid 2>/dev/null || true
    
    echo -e "${GREEN}[+] Package databases synchronized${RESET}"
    echo
}

show_summary() {
    echo
    echo -e "${CYAN}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
    echo -e "${CYAN}${BOLD}â•‘                   UNINSTALLATION SUMMARY                    â•‘${RESET}"
    echo -e "${CYAN}${BOLD}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${RESET}"
    echo -e "${CYAN}${BOLD}â•‘${RESET}  Total BlackArch Packages:    ${WHITE}${REMOVAL_STATS[total_available]}${RESET}"
    echo -e "${CYAN}${BOLD}â•‘${RESET}  Found Installed:             ${YELLOW}${REMOVAL_STATS[total_installed]}${RESET}"
    echo -e "${CYAN}${BOLD}â•‘${RESET}  Successfully Removed:        ${GREEN}${REMOVAL_STATS[removed]}${RESET}"
    echo -e "${CYAN}${BOLD}â•‘${RESET}  Failed to Remove:            ${RED}${REMOVAL_STATS[failed]}${RESET}"
    echo -e "${CYAN}${BOLD}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${RESET}"
    echo -e "${CYAN}${BOLD}â•‘${RESET}  Backup Location:                                        ${CYAN}${BOLD}â•‘${RESET}"
    echo -e "${CYAN}${BOLD}â•‘${RESET}  ${DIM}${BACKUP_DIR:0:57}${RESET}"
    echo -e "${CYAN}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo
    
    if [[ ${REMOVAL_STATS[removed]} -gt 0 ]]; then
        echo -e "${GREEN}${BOLD}[âœ“] Successfully removed ${REMOVAL_STATS[removed]} BlackArch packages${RESET}"
    fi
    
    if [[ ${REMOVAL_STATS[failed]} -gt 0 ]]; then
        echo -e "${YELLOW}[!] ${REMOVAL_STATS[failed]} packages could not be removed${RESET}"
        echo -e "    ${DIM}Check logs: $LOG_DIR/kygox_uninstall.log${RESET}"
    fi
    
    echo
}

confirm_removal() {
    if [[ "$FORCE_REMOVE" == "true" ]]; then
        return 0
    fi
    
    echo
    echo -e "${RED}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
    echo -e "${RED}${BOLD}â•‘                        âš ï¸  WARNING âš ï¸                        â•‘${RESET}"
    echo -e "${RED}${BOLD}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${RESET}"
    echo -e "${RED}${BOLD}â•‘${RESET}  This will remove ALL BlackArch packages from            ${RED}${BOLD}â•‘${RESET}"
    echo -e "${RED}${BOLD}â•‘${RESET}  your system.                                            ${RED}${BOLD}â•‘${RESET}"
    echo -e "${RED}${BOLD}â•‘${RESET}                                                          ${RED}${BOLD}â•‘${RESET}"
    echo -e "${RED}${BOLD}â•‘${RESET}  Packages to remove: ${YELLOW}${BOLD}${REMOVAL_STATS[total_installed]}${RESET}                              ${RED}${BOLD}â•‘${RESET}"
    echo -e "${RED}${BOLD}â•‘${RESET}                                                          ${RED}${BOLD}â•‘${RESET}"
    echo -e "${RED}${BOLD}â•‘${RESET}  A backup will be created before proceeding.            ${RED}${BOLD}â•‘${RESET}"
    echo -e "${RED}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo
    
    read -p "Type 'REMOVE ALL' to confirm: " -r confirmation
    
    if [[ "$confirmation" != "REMOVE ALL" ]]; then
        echo -e "${YELLOW}[!] Uninstallation cancelled${RESET}"
        exit 0
    fi
    echo
}

show_help() {
    cat << 'HELP_TEXT'
kygox-uninstall v1.0.1 Purge - BlackArch Removal Tool

DESCRIPTION:
    Removes BlackArch packages using the same correlation mechanism as the
    installer. Queries the BlackArch repository for the master package list,
    then correlates with installed packages to ensure safe removal.

REQUIREMENTS:
    â€¢ Root/sudo privileges
    â€¢ BlackArch repository must be configured
    â€¢ Internet connection to query repository

HOW IT WORKS:
    1. Check sudo privileges
    2. Verify BlackArch repository is accessible
    3. Query ALL packages from BlackArch repo (master list)
    4. Correlate: Check which packages are installed
    5. Show correlation results
    6. Confirm removal with user
    7. Remove only correlated packages
    8. Clean repository configuration
    9. Clean kygox configuration files

USAGE:
    sudo ./uninstall [OPTIONS]

OPTIONS:
    -h, --help              Show this help message
    -v, --verbose           Enable verbose output and logging
    -n, --dry-run          Preview what would be removed (no changes)
    -f, --force            Skip confirmation prompt
    -k, --keep-config      Keep kygox configuration files
    --keep-repo            Remove packages but keep repository config

EXAMPLES:
    # Normal usage (with confirmation)
    sudo ./uninstall

    # Preview mode - see what would be removed
    sudo ./uninstall -n

    # Force removal without confirmation
    sudo ./uninstall -f

    # Keep configuration files
    sudo ./uninstall -k

    # Remove packages but keep repo configured
    sudo ./uninstall --keep-repo

    # Verbose mode with dry-run
    sudo ./uninstall -v -n

CORRELATION MECHANISM:
    The uninstaller uses the same method as the installer:
    
    1. Query: pacman -Sl blackarch
       â†’ Gets all ~2800+ packages from BlackArch repository
    
    2. Check: pacman -Qi <package>
       â†’ For each package, check if it's installed
    
    3. Correlate: installed âˆ© blackarch_repo
       â†’ Only packages in BOTH lists are targeted for removal
    
    This ensures:
    â€¢ Only BlackArch packages are removed
    â€¢ No system packages are touched
    â€¢ Accurate package counting
    â€¢ Safe, targeted removal

SAFETY FEATURES:
    â€¢ Automatic backup before removal
    â€¢ Backups stored in: ~/.config/kygox/backups/
    â€¢ Detailed logging: ~/.kygox/kygox_uninstall.log
    â€¢ Dry-run mode available
    â€¢ Repository verification required
    â€¢ Confirmation prompt (unless forced)

NOTES:
    â€¢ If BlackArch repo is not configured, uninstaller cannot run
    â€¢ This is intentional - ensures accurate package identification
    â€¢ If you removed BlackArch already, there's nothing to uninstall
    â€¢ Repository access is needed for correlation, not for removal

TROUBLESHOOTING:
    "Repository not found":
      â†’ BlackArch was already removed or never installed
      â†’ Nothing to uninstall
    
    "Cannot access repository":
      â†’ Run: sudo pacman -Sy
      â†’ Check internet connection
    
    "No packages found":
      â†’ Already uninstalled
      â†’ System is clean

SUPPORT:
    Repository: https://github.com/0xb0rn3/kygox
    Author: 0xb0rn3 | IG: theehiv3 | X: 0xbv1
    Email: q4n0@proton.me

SEE ALSO:
    installer script (kygox) - Uses same correlation mechanism
HELP_TEXT
}

parse_arguments() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            -v|--verbose)
                VERBOSE_MODE=true
                shift
                ;;
            -n|--dry-run)
                DRY_RUN=true
                shift
                ;;
            -f|--force)
                FORCE_REMOVE=true
                shift
                ;;
            -k|--keep-config)
                KEEP_CONFIG=true
                shift
                ;;
            --keep-repo)
                KEEP_REPO=true
                shift
                ;;
            *)
                echo -e "${RED}[ERROR] Unknown option: $1${RESET}" >&2
                echo "Run with --help for usage information"
                exit 1
                ;;
        esac
    done
}

main() {
    # Initialize log
    log_message "INFO" "=== kygox-uninstall v${SCRIPT_VERSION} started ==="
    
    # Parse arguments first
    parse_arguments "$@"
    
    # Display banner
    print_banner
    
    # STEP 1: Check root privileges (MUST BE FIRST)
    echo -e "${CYAN}${BOLD}[*] Step 1: Privilege Check${RESET}"
    check_root
    echo -e "${GREEN}[âœ“] Running with root privileges${RESET}"
    echo
    
    # Show dry-run mode if enabled
    if [[ "$DRY_RUN" == "true" ]]; then
        echo -e "${YELLOW}${BOLD}[!] DRY RUN MODE - No changes will be made${RESET}"
        echo
    fi
    
    # STEP 2: Verify BlackArch repository is configured
    echo -e "${CYAN}${BOLD}[*] Step 2: Repository Verification${RESET}"
    echo -e "${DIM}  â†’ The uninstaller needs BlackArch repo to correlate packages${RESET}"
    echo
    
    if ! verify_blackarch_repository; then
        echo
        echo -e "${YELLOW}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
        echo -e "${YELLOW}${BOLD}â•‘                    CANNOT PROCEED                         â•‘${RESET}"
        echo -e "${YELLOW}${BOLD}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${RESET}"
        echo -e "${YELLOW}${BOLD}â•‘${RESET}  BlackArch repository must be configured to:           ${YELLOW}${BOLD}â•‘${RESET}"
        echo -e "${YELLOW}${BOLD}â•‘${RESET}    â€¢ Query the master package list                     ${YELLOW}${BOLD}â•‘${RESET}"
        echo -e "${YELLOW}${BOLD}â•‘${RESET}    â€¢ Correlate with installed packages                 ${YELLOW}${BOLD}â•‘${RESET}"
        echo -e "${YELLOW}${BOLD}â•‘${RESET}    â€¢ Ensure only BlackArch tools are removed           ${YELLOW}${BOLD}â•‘${RESET}"
        echo -e "${YELLOW}${BOLD}â•‘${RESET}                                                         ${YELLOW}${BOLD}â•‘${RESET}"
        echo -e "${YELLOW}${BOLD}â•‘${RESET}  If BlackArch was already removed, you're done!        ${YELLOW}${BOLD}â•‘${RESET}"
        echo -e "${YELLOW}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
        
        log_message "ERROR" "BlackArch repository not accessible"
        exit 1
    fi
    
    # STEP 3: Scan and correlate packages (SAME AS INSTALLER)
    echo -e "${CYAN}${BOLD}[*] Step 3: Package Discovery & Correlation${RESET}"
    echo -e "${DIM}  â†’ Using the same mechanism as the installer${RESET}"
    echo
    
    local packages_to_remove=()
    if ! mapfile -t packages_to_remove < <(scan_blackarch_packages); then
        # No packages found
        if [[ ${REMOVAL_STATS[total_installed]} -eq 0 ]]; then
            echo
            echo -e "${GREEN}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
            echo -e "${GREEN}${BOLD}â•‘                   SYSTEM IS CLEAN                         â•‘${RESET}"
            echo -e "${GREEN}${BOLD}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${RESET}"
            echo -e "${GREEN}${BOLD}â•‘${RESET}  No BlackArch packages found installed                ${GREEN}${BOLD}â•‘${RESET}"
            echo -e "${GREEN}${BOLD}â•‘${RESET}                                                         ${GREEN}${BOLD}â•‘${RESET}"
            echo -e "${GREEN}${BOLD}â•‘${RESET}  Would you like to clean the repository config?       ${GREEN}${BOLD}â•‘${RESET}"
            echo -e "${GREEN}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
            echo
            
            read -p "Remove BlackArch repository configuration? [y/N]: " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                create_backup
                remove_blackarch_repository
                sync_databases
                echo -e "${GREEN}[âœ“] Repository configuration removed${RESET}"
            else
                echo -e "${CYAN}[i] Repository configuration kept${RESET}"
            fi
            
            log_message "INFO" "No packages to remove, exiting"
            exit 0
        fi
    fi
    
    log_message "INFO" "Found ${#packages_to_remove[@]} packages to remove"
    
    # STEP 4: Confirm removal
    echo -e "${CYAN}${BOLD}[*] Step 4: Confirmation${RESET}"
    confirm_removal
    
    # STEP 5: Create backup
    if [[ "$DRY_RUN" != "true" ]]; then
        echo -e "${CYAN}${BOLD}[*] Step 5: Creating Backup${RESET}"
        create_backup
    fi
    
    # STEP 6: Remove correlated packages
    echo -e "${CYAN}${BOLD}[*] Step 6: Removing Correlated Packages${RESET}"
    echo -e "${DIM}  â†’ Removing ${#packages_to_remove[@]} packages found in correlation${RESET}"
    echo
    
    remove_packages "${packages_to_remove[@]}"
    
    # STEP 7: Remove repository configuration (unless keeping it)
    if [[ "$KEEP_REPO" != "true" ]]; then
        echo -e "${CYAN}${BOLD}[*] Step 7: Repository Cleanup${RESET}"
        remove_blackarch_repository
        sync_databases
    else
        echo -e "${YELLOW}[!] Keeping BlackArch repository configuration${RESET}"
        echo
    fi
    
    # STEP 8: Clean kygox files
    echo -e "${CYAN}${BOLD}[*] Step 8: Cleaning kygox Files${RESET}"
    clean_kygox_files
    
    # STEP 9: Show summary
    show_summary
    
    echo -e "${GREEN}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
    echo -e "${GREEN}${BOLD}â•‘              UNINSTALLATION COMPLETED                     â•‘${RESET}"
    echo -e "${GREEN}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    
    if [[ "$DRY_RUN" != "true" && "$KEEP_REPO" != "true" ]]; then
        echo
        echo -e "${CYAN}${BOLD}Post-cleanup recommendations:${RESET}"
        echo -e "  ${WHITE}â€¢${RESET} Run: ${GREEN}sudo pacman -Sc${RESET} to clean package cache"
        echo -e "  ${WHITE}â€¢${RESET} Run: ${GREEN}sudo pacman -Scc${RESET} to clean all cached packages"
    fi
    
    echo
    log_message "INFO" "=== kygox-uninstall completed successfully ==="
}

# Signal handlers
trap 'stop_loader; exit 130' INT TERM
trap 'stop_loader' EXIT

# Execute main
main "$@"
