#!/usr/bin/env bash

set -euo pipefail

# CONFIGURATION
readonly SCRIPT_VERSION="1.0.1"
readonly SCRIPT_CODENAME="Purge"
readonly AUTHOR="0xb0rn3"
readonly REPO_URL="https://github.com/0xb0rn3/kygox"

# System Configuration
readonly ORIGINAL_USER="${SUDO_USER:-$(whoami)}"
readonly USER_HOME=$(getent passwd "$ORIGINAL_USER" | cut -d: -f6)
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly LOG_DIR="$USER_HOME/.kygox"
readonly CONFIG_DIR="$USER_HOME/.config/kygox"
readonly BACKUP_DIR="$CONFIG_DIR/backups/uninstall_$(date +%Y%m%d_%H%M%S)"

# Colors and UI
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly PURPLE='\033[0;35m'
readonly CYAN='\033[0;36m'
readonly WHITE='\033[1;37m'
readonly BOLD='\033[1m'
readonly DIM='\033[2m'
readonly RESET='\033[0m'

# Global State
declare -g VERBOSE_MODE=false
declare -g DRY_RUN=false
declare -g FORCE_REMOVE=false
declare -g KEEP_CONFIG=false
declare -g KEEP_REPO=false
declare -g LOADER_PID=""
declare -A REMOVAL_STATS=(
    ["total_available"]=0
    ["total_installed"]=0
    ["removed"]=0
    ["failed"]=0
)

# ============================================================================
# ANIMATED LOADERS (Same as installer)
# ============================================================================

show_purge_loader() {
    local message="$1"
    local duration="${2:-5}"
    local pid="$$"
    
    (
        local frames=(
            "ğŸ—‘ï¸ "
            "ğŸ—‘ï¸."
            "ğŸ—‘ï¸.."
            "ğŸ—‘ï¸..."
            "â™»ï¸..."
            "â™»ï¸.."
            "â™»ï¸."
            "â™»ï¸ "
        )
        
        local start_time=$(date +%s)
        local i=0
        
        tput civis
        
        while kill -0 $pid 2>/dev/null; do
            local current_time=$(date +%s)
            local elapsed=$((current_time - start_time))
            
            if [[ $elapsed -ge $duration ]]; then
                break
            fi
            
            local frame="${frames[$((i % ${#frames[@]}))]}"
            local progress=$((elapsed * 100 / duration))
            
            local bar_width=40
            local filled=$((progress * bar_width / 100))
            local empty=$((bar_width - filled))
            
            printf "\r${RED}${BOLD}$frame ${message}${RESET} "
            printf "${RED}["
            printf "%${filled}s" | tr ' ' 'â–ˆ'
            printf "%${empty}s" | tr ' ' 'â–‘'
            printf "]${RESET} ${YELLOW}${progress}%%${RESET}"
            
            ((i++))
            sleep 0.1
        done
        
        printf "\r${GREEN}${BOLD}âœ“ ${message}${RESET}%*s\n" $(($(tput cols) - ${#message} - 3)) ""
        tput cnorm
    ) &
    
    LOADER_PID=$!
}

show_scan_loader() {
    local message="$1"
    local duration="${2:-5}"
    local pid="$$"
    
    (
        local start_time=$(date +%s)
        local i=0
        
        tput civis
        
        while kill -0 $pid 2>/dev/null; do
            local current_time=$(date +%s)
            local elapsed=$((current_time - start_time))
            
            if [[ $elapsed -ge $duration ]]; then
                break
            fi
            
            local progress=$((elapsed * 100 / duration))
            local bar_width=50
            local pos=$((i % bar_width))
            
            printf "\r${CYAN}${BOLD}ğŸ” ${message}${RESET} ${DIM}["
            for ((j=0; j<bar_width; j++)); do
                if [[ $j -eq $pos ]]; then
                    printf "${GREEN}${BOLD}â—†${RESET}${DIM}"
                else
                    printf "â”€"
                fi
            done
            printf "]${RESET} ${YELLOW}${progress}%%${RESET}"
            
            ((i++))
            sleep 0.05
        done
        
        printf "\r${GREEN}${BOLD}âœ“ ${message}${RESET}%*s\n" $(($(tput cols) - ${#message} - 3)) ""
        tput cnorm
    ) &
    
    LOADER_PID=$!
}

stop_loader() {
    if [[ -n "$LOADER_PID" ]] && kill -0 $LOADER_PID 2>/dev/null; then
        kill $LOADER_PID 2>/dev/null || true
        wait $LOADER_PID 2>/dev/null || true
    fi
    LOADER_PID=""
    tput cnorm
}

# ============================================================================
# CORE FUNCTIONS
# ============================================================================

log_message() {
    local level="$1"
    local message="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    mkdir -p "$LOG_DIR"
    echo "[$timestamp] [$level] $message" >> "$LOG_DIR/kygox_uninstall.log"
    
    if [[ "$VERBOSE_MODE" == "true" ]]; then
        echo "[$level] $message" >&2
    fi
}

error_exit() {
    local message="$1"
    local exit_code="${2:-1}"
    stop_loader
    log_message "ERROR" "$message"
    echo -e "${RED}${BOLD}[ERROR]${RESET} $message" >&2
    exit "$exit_code"
}

print_banner() {
    clear
    cat << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                      â•‘
â•‘        â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—                  â•‘
â•‘        â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•                  â•‘
â•‘        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ•”â•                   â•‘
â•‘        â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—                   â•‘
â•‘        â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—                  â•‘
â•‘        â•šâ•â•  â•šâ•â•   â•šâ•â•    â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•                  â•‘
â•‘                                                                      â•‘
â•‘                 ğŸ—‘ï¸  UNINSTALLER v1.0.1 Purge  â™»ï¸                     â•‘
â•‘               By 0xb0rn3 | Complete Removal Tool                    â•‘
â•‘                                                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
    echo
}

check_root() {
    echo -e "${CYAN}[*] Checking privileges...${RESET}"
    if [[ $EUID -ne 0 ]]; then
        error_exit "This script must be run with sudo privileges"
    fi
    echo -e "${GREEN}[âœ“] Running with root privileges${RESET}"
    echo
}

check_blackarch_configured() {
    if ! grep -q "^\[blackarch\]" /etc/pacman.conf 2>/dev/null; then
        echo -e "${YELLOW}[!] BlackArch repository not found in pacman.conf${RESET}"
        echo -e "${YELLOW}[!] Cannot scan for packages without repository configuration${RESET}"
        echo
        echo -e "${CYAN}[i] If you've already removed BlackArch, there's nothing to uninstall${RESET}"
        return 1
    fi
    return 0
}

create_backup() {
    log_message "INFO" "Creating backup before uninstallation..."
    echo -e "${CYAN}[*] Creating backup...${RESET}"
    
    mkdir -p "$BACKUP_DIR"
    
    # Backup pacman.conf
    if [[ -f /etc/pacman.conf ]]; then
        cp /etc/pacman.conf "$BACKUP_DIR/pacman.conf.backup"
        log_message "INFO" "Backed up pacman.conf"
    fi
    
    # Backup BlackArch mirrorlist
    if [[ -f /etc/pacman.d/blackarch-mirrorlist ]]; then
        cp /etc/pacman.d/blackarch-mirrorlist "$BACKUP_DIR/blackarch-mirrorlist.backup"
        log_message "INFO" "Backed up BlackArch mirrorlist"
    fi
    
    # Save list of installed BlackArch packages
    if command -v pacman &>/dev/null; then
        pacman -Qq 2>/dev/null | while read pkg; do
            if pacman -Qi "$pkg" 2>/dev/null | grep -q "^Repository.*blackarch"; then
                echo "$pkg"
            fi
        done > "$BACKUP_DIR/blackarch_packages.txt"
        log_message "INFO" "Saved list of installed packages"
    fi
    
    echo -e "${GREEN}[+] Backup created at: ${DIM}$BACKUP_DIR${RESET}"
    echo
}

scan_blackarch_packages() {
    echo -e "${CYAN}${BOLD}[*] Scanning System for BlackArch Packages${RESET}"
    echo
    
    # Step 1: Check if BlackArch is configured
    echo -e "${CYAN}[*] Step 1/3: Verifying BlackArch repository...${RESET}"
    
    if ! check_blackarch_configured; then
        return 1
    fi
    
    echo -e "${GREEN}[âœ“] BlackArch repository found in pacman.conf${RESET}"
    echo
    
    # Step 2: Get ALL BlackArch packages from repository (like installer does)
    echo -e "${CYAN}[*] Step 2/3: Querying BlackArch repository...${RESET}"
    
    show_scan_loader "Scanning BlackArch repository" 3 &
    local loader_pid=$!
    
    local all_blackarch_packages=()
    
    # This is exactly how the installer does it
    if pacman -Sl blackarch &>/dev/null; then
        mapfile -t all_blackarch_packages < <(pacman -Sl blackarch 2>/dev/null | awk '{print $2}' | sort -u)
        REMOVAL_STATS["total_available"]=${#all_blackarch_packages[@]}
    else
        wait $loader_pid 2>/dev/null || true
        echo -e "${RED}[âœ—] Cannot access BlackArch repository${RESET}"
        return 1
    fi
    
    wait $loader_pid 2>/dev/null || true
    
    echo -e "${GREEN}[âœ“] Found ${REMOVAL_STATS[total_available]} packages in BlackArch repository${RESET}"
    echo
    
    # Step 3: Check which ones are installed (like installer does)
    echo -e "${CYAN}[*] Step 3/3: Checking installed packages...${RESET}"
    
    show_scan_loader "Analyzing installed packages" 3 &
    loader_pid=$!
    
    local installed_blackarch_packages=()
    
    # Check each BlackArch package to see if it's installed
    for pkg in "${all_blackarch_packages[@]}"; do
        if pacman -Qi "$pkg" &>/dev/null; then
            installed_blackarch_packages+=("$pkg")
        fi
    done
    
    REMOVAL_STATS["total_installed"]=${#installed_blackarch_packages[@]}
    
    wait $loader_pid 2>/dev/null || true
    
    echo -e "${GREEN}[âœ“] Found ${REMOVAL_STATS[total_installed]} installed BlackArch packages${RESET}"
    echo
    
    # Display results
    echo -e "${GREEN}${BOLD}[+] Scan Results:${RESET}"
    echo -e "  ${WHITE}â€¢${RESET} Total BlackArch packages: ${REMOVAL_STATS[total_available]}"
    echo -e "  ${WHITE}â€¢${RESET} Installed on your system: ${RED}${BOLD}${REMOVAL_STATS[total_installed]}${RESET}"
    echo
    
    if [[ ${REMOVAL_STATS[total_installed]} -eq 0 ]]; then
        echo -e "${GREEN}[+] No BlackArch packages found installed${RESET}"
        return 1
    fi
    
    # Show sample of installed packages
    echo -e "${YELLOW}Installed BlackArch packages (showing first 30):${RESET}"
    local count=0
    for pkg in "${installed_blackarch_packages[@]}"; do
        if [[ $count -ge 30 ]]; then
            echo -e "  ${DIM}... and $((${#installed_blackarch_packages[@]} - 30)) more packages${RESET}"
            break
        fi
        echo -e "  ${RED}â€¢${RESET} $pkg"
        ((count++))
    done
    echo
    
    # Return the list
    printf '%s\n' "${installed_blackarch_packages[@]}"
}

remove_package() {
    local package="$1"
    
    if [[ "$DRY_RUN" == "true" ]]; then
        echo -e "${YELLOW}[DRY RUN] Would remove: $package${RESET}"
        ((REMOVAL_STATS["removed"]++))
        return 0
    fi
    
    log_message "INFO" "Removing package: $package"
    
    # Try multiple removal methods
    if pacman -Rns --noconfirm "$package" >> "$LOG_DIR/kygox_uninstall.log" 2>&1; then
        echo -e "${GREEN}[+] Removed: $package${RESET}"
        ((REMOVAL_STATS["removed"]++))
        return 0
    elif pacman -Rn --noconfirm "$package" >> "$LOG_DIR/kygox_uninstall.log" 2>&1; then
        echo -e "${GREEN}[+] Removed (no deps): $package${RESET}"
        ((REMOVAL_STATS["removed"]++))
        return 0
    elif pacman -Rdd --noconfirm "$package" >> "$LOG_DIR/kygox_uninstall.log" 2>&1; then
        echo -e "${YELLOW}[!] Removed (forced): $package${RESET}"
        ((REMOVAL_STATS["removed"]++))
        return 0
    else
        echo -e "${RED}[!] Failed: $package${RESET}"
        log_message "ERROR" "Failed to remove: $package"
        ((REMOVAL_STATS["failed"]++))
        return 1
    fi
}

remove_packages() {
    local packages=("$@")
    
    if [[ ${#packages[@]} -eq 0 ]]; then
        echo -e "${YELLOW}[!] No packages to remove${RESET}"
        return 0
    fi
    
    echo -e "${CYAN}${BOLD}[*] Removing ${#packages[@]} BlackArch Packages${RESET}"
    echo
    
    if [[ "$DRY_RUN" != "true" ]]; then
        show_purge_loader "Preparing removal process" 2 &
        wait $LOADER_PID 2>/dev/null || true
    fi
    
    # Process in batches for better output
    local batch_size=10
    local total_batches=$(( (${#packages[@]} + batch_size - 1) / batch_size ))
    
    for ((i=0; i<${#packages[@]}; i+=batch_size)); do
        local batch=("${packages[@]:i:batch_size}")
        local batch_num=$(( i / batch_size + 1 ))
        
        echo -e "${CYAN}[*] Batch $batch_num/$total_batches${RESET}"
        
        for pkg in "${batch[@]}"; do
            remove_package "$pkg"
        done
        
        local progress=$(( (i + batch_size) * 100 / ${#packages[@]} ))
        if [[ $progress -gt 100 ]]; then
            progress=100
        fi
        echo -e "${GREEN}[+] Progress: ${progress}% (Removed: ${REMOVAL_STATS[removed]}, Failed: ${REMOVAL_STATS[failed]})${RESET}"
        echo
    done
}

remove_blackarch_repository() {
    echo -e "${CYAN}${BOLD}[*] Removing BlackArch Repository Configuration${RESET}"
    echo
    
    if [[ "$DRY_RUN" == "true" ]]; then
        echo -e "${YELLOW}[DRY RUN] Would remove BlackArch repository configuration${RESET}"
        return 0
    fi
    
    show_purge_loader "Cleaning repository configuration" 3 &
    local loader_pid=$!
    
    # Remove BlackArch from pacman.conf
    if [[ -f /etc/pacman.conf ]]; then
        sed -i '/^\[blackarch\]/,/^$/d' /etc/pacman.conf
        log_message "INFO" "Removed BlackArch from pacman.conf"
    fi
    
    # Remove BlackArch mirrorlist
    if [[ -f /etc/pacman.d/blackarch-mirrorlist ]]; then
        rm -f /etc/pacman.d/blackarch-mirrorlist
        log_message "INFO" "Removed BlackArch mirrorlist"
    fi
    
    # Remove BlackArch keyring package
    if pacman -Qi blackarch-keyring &>/dev/null; then
        pacman -Rns --noconfirm blackarch-keyring >> "$LOG_DIR/kygox_uninstall.log" 2>&1 || true
        log_message "INFO" "Removed BlackArch keyring package"
    fi
    
    # Remove BlackArch keys from pacman keyring
    pacman-key --delete 4345771566D76038C7FEB43863EC0ADBEA87E4E3 2>/dev/null || true
    
    wait $loader_pid 2>/dev/null || true
    
    echo -e "${GREEN}[+] BlackArch repository configuration removed${RESET}"
    echo
}

clean_kygox_files() {
    if [[ "$KEEP_CONFIG" == "true" ]]; then
        echo -e "${YELLOW}[!] Keeping kygox configuration files${RESET}"
        return 0
    fi
    
    echo -e "${CYAN}${BOLD}[*] Cleaning kygox Files${RESET}"
    echo
    
    local files_to_remove=(
        "$CONFIG_DIR"
        "$LOG_DIR"
    )
    
    for file in "${files_to_remove[@]}"; do
        # Don't remove backup directory we just created
        if [[ "$file" == *"$BACKUP_DIR"* ]]; then
            continue
        fi
        
        if [[ -n "$file" && -e "$file" ]]; then
            if [[ "$DRY_RUN" == "true" ]]; then
                echo -e "${YELLOW}[DRY RUN] Would remove: $file${RESET}"
            else
                # Keep the backup directory
                if [[ "$file" == "$CONFIG_DIR" ]]; then
                    find "$file" -mindepth 1 -maxdepth 1 ! -path "*/backups" -exec rm -rf {} + 2>/dev/null || true
                else
                    rm -rf "$file" 2>/dev/null || true
                fi
                echo -e "${GREEN}[+] Cleaned: $file${RESET}"
                log_message "INFO" "Removed: $file"
            fi
        fi
    done
    
    echo
}

sync_databases() {
    if [[ "$DRY_RUN" == "true" ]]; then
        echo -e "${YELLOW}[DRY RUN] Would synchronize package databases${RESET}"
        return 0
    fi
    
    echo -e "${CYAN}[*] Synchronizing package databases...${RESET}"
    
    show_scan_loader "Updating package databases" 2 &
    local loader_pid=$!
    
    pacman -Sy --noconfirm >> "$LOG_DIR/kygox_uninstall.log" 2>&1
    
    wait $loader_pid 2>/dev/null || true
    
    echo -e "${GREEN}[+] Package databases synchronized${RESET}"
    echo
}

show_summary() {
    echo
    echo -e "${CYAN}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
    echo -e "${CYAN}${BOLD}â•‘                   UNINSTALLATION SUMMARY                    â•‘${RESET}"
    echo -e "${CYAN}${BOLD}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${RESET}"
    echo -e "${CYAN}${BOLD}â•‘${RESET}  Total BlackArch Packages:    ${WHITE}${REMOVAL_STATS[total_available]}${RESET}"
    echo -e "${CYAN}${BOLD}â•‘${RESET}  Found Installed:             ${YELLOW}${REMOVAL_STATS[total_installed]}${RESET}"
    echo -e "${CYAN}${BOLD}â•‘${RESET}  Successfully Removed:        ${GREEN}${REMOVAL_STATS[removed]}${RESET}"
    echo -e "${CYAN}${BOLD}â•‘${RESET}  Failed to Remove:            ${RED}${REMOVAL_STATS[failed]}${RESET}"
    echo -e "${CYAN}${BOLD}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${RESET}"
    echo -e "${CYAN}${BOLD}â•‘${RESET}  Backup Location:                                        ${CYAN}${BOLD}â•‘${RESET}"
    echo -e "${CYAN}${BOLD}â•‘${RESET}  ${DIM}${BACKUP_DIR:0:57}${RESET}"
    echo -e "${CYAN}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo
    
    if [[ ${REMOVAL_STATS[removed]} -gt 0 ]]; then
        echo -e "${GREEN}${BOLD}[âœ“] Successfully removed ${REMOVAL_STATS[removed]} BlackArch packages${RESET}"
    fi
    
    if [[ ${REMOVAL_STATS[failed]} -gt 0 ]]; then
        echo -e "${YELLOW}[!] ${REMOVAL_STATS[failed]} packages could not be removed${RESET}"
        echo -e "    ${DIM}Check logs: $LOG_DIR/kygox_uninstall.log${RESET}"
    fi
    
    echo
}

confirm_removal() {
    if [[ "$FORCE_REMOVE" == "true" ]]; then
        return 0
    fi
    
    echo
    echo -e "${RED}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
    echo -e "${RED}${BOLD}â•‘                        âš ï¸  WARNING âš ï¸                        â•‘${RESET}"
    echo -e "${RED}${BOLD}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${RESET}"
    echo -e "${RED}${BOLD}â•‘${RESET}  This will remove ALL BlackArch packages from            ${RED}${BOLD}â•‘${RESET}"
    echo -e "${RED}${BOLD}â•‘${RESET}  your system.                                            ${RED}${BOLD}â•‘${RESET}"
    echo -e "${RED}${BOLD}â•‘${RESET}                                                          ${RED}${BOLD}â•‘${RESET}"
    echo -e "${RED}${BOLD}â•‘${RESET}  Packages to remove: ${YELLOW}${BOLD}${REMOVAL_STATS[total_installed]}${RESET}                              ${RED}${BOLD}â•‘${RESET}"
    echo -e "${RED}${BOLD}â•‘${RESET}                                                          ${RED}${BOLD}â•‘${RESET}"
    echo -e "${RED}${BOLD}â•‘${RESET}  A backup will be created before proceeding.            ${RED}${BOLD}â•‘${RESET}"
    echo -e "${RED}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo
    
    read -p "Type 'REMOVE ALL' to confirm: " -r confirmation
    
    if [[ "$confirmation" != "REMOVE ALL" ]]; then
        echo -e "${YELLOW}[!] Uninstallation cancelled${RESET}"
        exit 0
    fi
    echo
}

show_help() {
    cat << 'HELP_TEXT'
kygox-uninstall v1.0.1 Purge - BlackArch Removal Tool

USAGE:
    sudo ./uninstall [OPTIONS]

OPTIONS:
    -h, --help              Show this help message
    -v, --verbose           Enable verbose output
    -n, --dry-run          Show what would be removed without removing
    -f, --force            Force removal without confirmation
    -k, --keep-config      Keep kygox configuration files
    --keep-repo            Remove packages but keep repository configuration

EXAMPLES:
    sudo ./uninstall                # Interactive removal with confirmation
    sudo ./uninstall -n             # Preview what would be removed
    sudo ./uninstall -f             # Force removal without prompts
    sudo ./uninstall -k             # Keep configuration files
    sudo ./uninstall --keep-repo    # Remove packages but keep repo

NOTES:
    - Scans ALL BlackArch packages like the installer does
    - Shows exactly what's installed before removing
    - Creates automatic backup before removal
    - Backups stored in: ~/.config/kygox/backups/
    - Logs saved to: ~/.kygox/kygox_uninstall.log

SUPPORT:
    Repository: https://github.com/0xb0rn3/kygox
    Author: 0xb0rn3
    Email: q4n0@proton.me
HELP_TEXT
}

parse_arguments() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            -v|--verbose)
                VERBOSE_MODE=true
                shift
                ;;
            -n|--dry-run)
                DRY_RUN=true
                shift
                ;;
            -f|--force)
                FORCE_REMOVE=true
                shift
                ;;
            -k|--keep-config)
                KEEP_CONFIG=true
                shift
                ;;
            --keep-repo)
                KEEP_REPO=true
                shift
                ;;
            *)
                echo -e "${RED}[ERROR] Unknown option: $1${RESET}" >&2
                echo "Run with --help for usage information"
                exit 1
                ;;
        esac
    done
}

main() {
    # Initialize log
    log_message "INFO" "=== kygox-uninstall v${SCRIPT_VERSION} started ==="
    
    # Parse arguments
    parse_arguments "$@"
    
    # Display banner
    print_banner
    
    # Check root
    check_root
    
    # Show mode
    if [[ "$DRY_RUN" == "true" ]]; then
        echo -e "${YELLOW}${BOLD}[!] DRY RUN MODE - No changes will be made${RESET}"
        echo
    fi
    
    # Scan for BlackArch packages (EXACTLY like installer)
    local packages_to_remove=()
    if ! mapfile -t packages_to_remove < <(scan_blackarch_packages); then
        if [[ ${REMOVAL_STATS[total_installed]} -eq 0 ]]; then
            echo -e "${GREEN}${BOLD}[âœ“] Nothing to remove - no BlackArch packages installed${RESET}"
            
            # Still offer to clean repo config
            if check_blackarch_configured; then
                echo
                read -p "Remove BlackArch repository configuration? [y/N]: " -n 1 -r
                echo
                if [[ $REPLY =~ ^[Yy]$ ]]; then
                    remove_blackarch_repository
                    sync_databases
                fi
            fi
            
            exit 0
        fi
    fi
    
    # Confirm removal
    confirm_removal
    
    # Create backup
    if [[ "$DRY_RUN" != "true" ]]; then
        create_backup
    fi
    
    # Remove packages
    remove_packages "${packages_to_remove[@]}"
    
    # Remove repository configuration (unless keeping it)
    if [[ "$KEEP_REPO" != "true" ]]; then
        remove_blackarch_repository
        sync_databases
    fi
    
    # Clean kygox files
    clean_kygox_files
    
    # Show summary
    show_summary
    
    echo -e "${GREEN}${BOLD}[âœ“] Uninstallation complete!${RESET}"
    
    if [[ "$DRY_RUN" != "true" && "$KEEP_REPO" != "true" ]]; then
        echo -e "${CYAN}[i] You may want to run 'sudo pacman -Sc' to clean package cache${RESET}"
    fi
    
    log_message "INFO" "=== kygox-uninstall completed successfully ==="
}

# Signal handlers
trap 'stop_loader; exit 130' INT TERM
trap 'stop_loader' EXIT

# Execute main
main "$@"
